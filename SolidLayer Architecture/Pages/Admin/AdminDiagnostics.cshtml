@page
@model SolidLayer_Architecture.Pages.Admin.AdminDiagnosticsModel
@{
    ViewData["Title"] = "Admin Diagnostics";
}

<div class="container">
    <h1>Admin User Diagnostics</h1>
    <p class="lead">Use this page to diagnose and fix issues with the admin user account.</p>

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> @Model.StatusMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
        </div>
    }

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Admin User Status</h5>
                </div>
                <div class="card-body">
                    @if (Model.AdminExists)
                    {
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-person-check-fill"></i> Admin user exists in the database.
                        </div>
                        <table class="table table-sm table-bordered">
                            <tr>
                                <th>User ID:</th>
                                <td>@Model.AdminUser["UserID"]</td>
                            </tr>
                            <tr>
                                <th>Name:</th>
                                <td>@Model.AdminUser["Name"]</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>@Model.AdminUser["Email"]</td>
                            </tr>
                            <tr>
                                <th>Role ID:</th>
                                <td>@Model.AdminUser["RoleID"]</td>
                            </tr>
                            <tr>
                                <th>Role Name:</th>
                                <td>@Model.AdminUser["RoleName"]</td>
                            </tr>
                            <tr>
                                <th>Password Hash:</th>
                                <td>
                                    <code class="text-break">@Model.AdminUser["Password"]</code>
                                </td>
                            </tr>
                        </table>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-person-x-fill"></i> Admin user does not exist in the database!
                        </div>

                        <h5>Database Status:</h5>
                        <table class="table table-sm table-bordered">
                            <tr>
                                <th>Roles Table Exists:</th>
                                <td>@(Model.AdminUser.ContainsKey("RolesTableExists") ? Model.AdminUser["RolesTableExists"] : "Unknown")</td>
                            </tr>
                            <tr>
                                <th>Admin Role Exists:</th>
                                <td>@(Model.AdminUser.ContainsKey("AdminRoleExists") ? Model.AdminUser["AdminRoleExists"] : "Unknown")</td>
                            </tr>
                            <tr>
                                <th>Users Table Exists:</th>
                                <td>@(Model.AdminUser.ContainsKey("UsersTableExists") ? Model.AdminUser["UsersTableExists"] : "Unknown")</td>
                            </tr>
                        </table>
                    }
                </div>
                <div class="card-footer">
                    <form method="post" asp-page-handler="ForceCreateAdmin">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-person-fill-gear"></i> Force Create/Update Admin User
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Password Verification</h5>
                </div>
                <div class="card-body">
                    <p>Test if the admin password <code>admin123</code> matches the stored hash:</p>
                    <form method="post" asp-page-handler="TestLogin" class="mb-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-key"></i> Test Admin Login
                        </button>
                    </form>

                    @if (!string.IsNullOrEmpty(Model.AdminPasswordDebug))
                    {
                        <div class="card bg-light">
                            <div class="card-header">Debug Information</div>
                            <div class="card-body">
                                <pre class="mb-0"><code>@Model.AdminPasswordDebug</code></pre>
                            </div>
                        </div>
                    }

                    <div class="alert alert-info mt-3">
                        <strong>Correct Admin Credentials:</strong>
                        <ul class="mb-0">
                            <li>Email: <code>admin@swipe2try.com</code></li>
                            <li>Password: <code>admin123</code></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">SQL User Authentication Debug Information</h5>
            </div>
            <div class="card-body">
                <p>This shows the SQL statement used to authenticate a user:</p>
                <pre class="bg-light p-3"><code>SELECT u.*, r.RoleName 
FROM USERS u
JOIN ROLES r ON u.RoleID = r.RoleID
WHERE u.Email = 'admin@swipe2try.com';</code></pre>
                
                <p>The password verification in C# code:</p>
                <pre class="bg-light p-3"><code>private bool VerifyPassword(string password, string hashedPassword)
{
    string hashOfInput = HashPassword(password);
    
    // Create a StringComparer for a case-insensitive comparison
    StringComparer comparer = StringComparer.OrdinalIgnoreCase;
    
    return comparer.Compare(hashOfInput, hashedPassword) == 0;
}</code></pre>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="/Admin/UserDiagnostics" class="btn btn-secondary me-2">
            <i class="bi bi-people"></i> User Diagnostics
        </a>
        <a href="/Account/Login" class="btn btn-primary">
            <i class="bi bi-box-arrow-in-right"></i> Go to Login Page
        </a>
    </div>
</div>
